# Use the official Anaconda base image
FROM continuumio/anaconda3:latest

# Set the working directory to /app
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    wget \
    unzip \
    gdal-bin \
    libgdal-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN conda install --yes \
    gdal=3.10.0 \
    mdal \
    psycopg2 \
    pip

# Upgrade pip
RUN pip install --upgrade pip

# Install other necessary packages
RUN pip install mdal psycopg2-binary

# Download the ZIP file
RUN wget https://ehydroprod.blob.core.usgovcloudapi.net/ehydro-surveys/CENWS/CENWS_DIS_SZ_01_HMBX_20240610_CS_E_5_16_61.ZIP

# Unzip the file
RUN unzip CENWS_DIS_SZ_01_HMBX_20240610_CS_E_5_16_61.ZIP -d /app

# Run MDAL to convert the Esri TIN to a GeoTIFF
RUN mdal_translate -of GTiff -tr 1 1 ESRI_TIN:"/app/SZ_01_HMBX_20240610_CS_E_5_16_61_tin/tdenv9.adf" /app/output.tif

# # Smooth the raster using gdal
# RUN gdalwarp -s_srs EPSG:4326 -t_srs EPSG:4326 -r cubic /app/output.tif /app/smoothed_output.tif

# # Generate contours using GDAL
# RUN gdal_contour -a elev /app/smoothed_output.tif /app/contours.shp

# # Add PostGIS layer and insert the contour data (assuming PostGIS setup is available)
# # Note: You'll need a PostGIS database running for this step to work
# RUN ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres password=yourpassword dbname=yourdb" /app/contours.shp

# Set the default command to run a Python script (if needed)
CMD ["python", "process.py"]
