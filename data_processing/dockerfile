# Use Python 3.12 as base image
FROM python:3.12

# Install system dependencies and tools
RUN apt-get update && apt-get install -y \
    wget \
    unzip \
    build-essential \
    gdal-bin \
    libgdal-dev \
    # cmake \
    # git \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN pip install --upgrade pip
RUN pip install gdal
RUN pip install psycopg2-binary
# downgrade mdal so it points to the correct gdal version
RUN pip install mdal==1.2

# Set working directory
WORKDIR /app

# Download the ZIP file
RUN wget https://ehydroprod.blob.core.usgovcloudapi.net/ehydro-surveys/CENWS/CENWS_DIS_SZ_01_HMBX_20240610_CS_E_5_16_61.ZIP

# Unzip the file
RUN unzip CENWS_DIS_SZ_01_HMBX_20240610_CS_E_5_16_61.ZIP -d /app

# Run MDAL to convert the Esri TIN to a GeoTIFF
RUN mdal_translate -of GTiff -tr 1 1 ESRI_TIN:"/app/SZ_01_HMBX_20240610_CS_E_5_16_61_tin/tdenv9.adf" /app/output.tif

# Smooth the raster using gdal
# RUN gdalwarp -s_srs EPSG:4326 -t_srs EPSG:4326 -r cubic /app/output.tif /app/smoothed_output.tif

# Generate contours using GDAL
# RUN gdal_contour -a elev /app/smoothed_output.tif /app/contours.shp

# Add PostGIS layer and insert the contour data (assuming PostGIS setup is available)
# Note: You'll need a PostGIS database running for this step to work
# Create a connection to PostGIS (adjust credentials accordingly)
# RUN ogr2ogr -f "PostgreSQL" PG:"host=localhost user=postgres password=yourpassword dbname=yourdb" /app/contours.shp

# Set the default command to run the Python script (if needed)
CMD ["python", "process.py"]
